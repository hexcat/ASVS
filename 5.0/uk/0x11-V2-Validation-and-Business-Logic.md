# V2 Валідація та бізнес-логіка

## Мета контролю

Цей розділ має на меті забезпечити, щоб перевірений застосунок відповідав наступним високорівневим цілям:

* Вхідні дані, що надходять до застосунку, відповідають бізнесовим або функціональним очікуванням.
* Потік бізнес-логіки є послідовним, обробляється у визначеному порядку та не може бути обійдений.
* Бізнес-логіка містить обмеження та контролі для виявлення та запобігання автоматизованим атакам, таким як безперервні малі перекази коштів або додавання мільйона друзів по одному.
* Потоки бізнес-логіки з високою цінністю враховують випадки зловживань і зловмисників, а також мають захист від підробки, фальсифікацій, розкриття інформації та атак на підвищення привілеїв.

## V2.1 Документація з валідації та бізнес-логіки

Документація з валідації та бізнес-логіки повинна чітко визначати межі бізнес-логіки, правила валідації та контекстну узгодженість поєднаних даних, щоб було зрозуміло, що саме необхідно реалізувати в застосунку.

| # | Опис | Рівень |
| :---: | :--- | :---: |
| **2.1.1** | Перевірити, що документація застосунку визначає правила валідації вхідних даних для перевірки їх відповідності очікуваній структурі. Це можуть бути загальні формати даних, такі як номери кредитних карток, електронні адреси, номери телефонів, або ж внутрішній формат даних. | 1 |
| **2.1.2** | Перевірити, що документація застосунку визначає, як здійснювати перевірку логічної та контекстної узгодженості поєднаних даних, наприклад, перевірку відповідності між назвою передмістя (suburb) та поштовим індексом (ZIP код). | 2 |
| **2.1.3** | Перевірити, що очікування щодо меж бізнес-логіки та правил валідації задокументовані, включно з вимогами як на рівні окремого користувача, так і на глобальному рівні застосунку. | 2 |

## V2.2 Валідація вхідних даних

Ефективний контроль валідації вхідних даних забезпечує дотримання бізнес- або функціональних вимог щодо типу даних, які очікує отримати застосунок. Це гарантує високу якість даних та зменшує площу атаки. Водночас це не усуває і не замінює необхідність правильного кодування, параметризації або санітизації даних під час їх використання в інших компонентах або при відображенні вихідних даних.

У цьому контексті "вхідні дані" можуть надходити з різноманітних джерел, включно з полями HTML-форм, REST-запитами, параметрами URL, HTTP-заголовками, cookies, файлами на диску, базами даних і зовнішніми API.

Контроль бізнес-логіки може, перевіряти, що конкретне вхідне значення є числом меншим за 100. Функціональна вимога може полягати у перевірці, що число не перевищує певний поріг, оскільки це число контролює кількість повторень певного циклу, і надто велике значення може призвести до надмірного навантаження та потенційної відмови в обслуговуванні (DoS).

Хоча Schema Validation не є обов’язковою, вона може бути найефективнішим механізмом для повного охоплення валідації HTTP APIs або інших інтерфейсів, які використовують JSON або XML.

Зверніть увагу на наступні моменти щодо Schema Validation:

* "Опублікована версія" специфікації JSON Schema Validation вважається готовою для використання в продуктивному середовищі, але формально не є повністю "стабільною". При застосуванні JSON Schema Validation необхідно переконатися у відсутності розбіжностей із вимогами, наведеними нижче.
* Використовувані бібліотеки для JSON Schema validation також слід контролювати і за потреби оновлювати після офіційного затвердження стандарту.
* Валідація за допомогою DTD не рекомендується, а оцінка DTD у рамках фреймворків має бути відключена, щоб уникнути проблем із XXE-атаками, спрямованими на DTDs.

| # | Опис | Рівень |
| :---: | :--- | :---: |
| **2.2.1** | Перевірити, що вхідні дані валідовані для забезпечення дотримання бізнесових або функціональних вимог до цих вхідних даних. Валідація має виконуватися або шляхом позитивної перевірки за дозволеним переліком значень, шаблонів та діапазонів, або шляхом порівняння вхідних даних із очікуваною структурою та логічними межами відповідно до заздалегідь визначених правил. Для рівня L1, валідація може зосереджуватися на вхідних даних, які використовуються для прийняття конкретних бізнесових або безпекових рішень. Для рівня L2 і вище, ця вимога має застосовуватися до всіх вхідних даних. | 1 |
| **2.2.2** | Перевірити, що застосунок спроєктовано таким чином, щоб забезпечувати валідацію вхідних даних на рівні довіреного сервісного шару. Хоча валідація на стороні клієнта покращує зручність використання і її слід заохочувати, її не можна розглядати як єдиний захисний механізм безпеки. | 1 |
| **2.2.3** | Перевірити, що застосунок гарантує, що поєднання пов’язаних даних є логічно правильним відповідно до заздалегідь визначених правил. | 2 |

## V2.3 Безпека бізнес-логіки

Цей розділ розглядає основні вимоги для забезпечення того, щоб застосунок коректно реалізовував бізнес-логіку та був захищений від атак, які експлуатують логіку та послідовність роботи застосунку.

| # | Опис | Рівень |
| :---: | :--- | :---: |
| **2.3.1** | Перевірити, що застосунок обробляє бізнес-логіку для одного й того ж користувача лише у передбаченому послідовному порядку кроків і без пропуску цих кроків. | 1 |
| **2.3.2** | Перевірити, що обмеження бізнес-логіки реалізовані відповідно до документації застосунку, щоб уникнути експлуатації вразливостей у бізнес-логіці. | 2 |
| **2.3.3** | Перевірити, що на рівні бізнес-логіки використовуються транзакції, які забезпечують повне виконання операції або її відкат до попереднього коректного стану. | 2 |
| **2.3.4** | Перевірити, що на рівні бізнес-логіки застосовуються механізми блокування для запобігання подвійного резервування обмежених ресурсів (наприклад, місць у театрі або часових слотів доставки) шляхом маніпуляції логікою застосунку. | 2 |
| **2.3.5** | Перевірити, що для бізнес-процесів із високою цінністю, потрібне схвалення кількох користувачів (multi-user approval), щоб запобігти несанкціонованим або випадковим діям. Це може стосуватися, зокрема, великих грошових переказів, затвердження контрактів, доступу до конфіденційної інформації або відключення систем безпеки у виробництві. | 3 |

## V2.4 Антиавтоматизація

Цей розділ містить антиавтоматизаційні контролі, які забезпечують необхідність взаємодії, схожої на людську, та запобігають надмірній кількості автоматизованих запитів.

| # | Опис | Рівень |
| :---: | :--- | :---: |
| **2.4.1** | Перевірити, що впроваджено антиавтоматизаційні контролі для захисту від надмірної кількості викликів функцій застосунку, які можуть призвести до витоку даних, створення некоректних даних, вичерпання квот, перевищення лімітів на частоту запитів, відмови в обслуговуванні(DoS) або надмірного використання дорогих ресурсів. | 2 |
| **2.4.2** | Перевірити, що бізнес-процеси враховують реалістичні часові проміжки між діями людини, запобігаючи надто швидкому надходженню транзакцій. | 3 |

## Посилання

Для додаткової інформації дивіться також:

* [OWASP Web Security Testing Guide: Input Validation Testing](https://owasp.org/www-project-web-security-testing-guide/v42/4-Web_Application_Security_Testing/07-Input_Validation_Testing/README.html)
* [OWASP Web Security Testing Guide: Business Logic Testing](https://owasp.org/www-project-web-security-testing-guide/v42/4-Web_Application_Security_Testing/10-Business_Logic_Testing/README)
* Антиавтоматизацію можна реалізувати різними способами, зокрема з використанням [OWASP Automated Threats to Web Applications](https://owasp.org/www-project-automated-threats-to-web-applications/)
* [OWASP Input Validation Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Input_Validation_Cheat_Sheet.html)
* [JSON Schema](https://json-schema.org/specification.html)
